# Edoc Query System

机器截图查询系统，支持按品牌、型号搜索截图。

## 项目结构

```
├── screenshot-backend/      # Django 后端
│   ├── screenshots/         # 截图文件目录（需手动添加）
│   │   ├── Error Code/      # 错误代码模式
│   │   │   └── 品牌/型号/   # 截图文件
│   │   ├── Video Tutorial/  # 视频教程模式
│   │   │   └── 品牌/        # 视频文件
│   │   └── Component IO Check/  # 组件检查模式
│   │       └── 品牌/        # JSON 数据文件
│   └── ...
├── machine-screenshot-query/ # Vue 前端
└── docker-compose.yml
```

---

## 如何添加新型号

### 1. 目录结构

截图文件存放在 `screenshot-backend/screenshots/` 目录下，结构为：

```
screenshots/
├── Error Code/
│   └── 品牌名/
│       └── 型号名/
│           └── 截图文件.jpg
├── Video Tutorial/
│   └── 品牌名/
│       └── 视频文件.mp4
└── Component IO Check/
    └── 品牌名/
        └── 数据文件.json
```

### 2. 添加步骤

**添加新品牌：**
```bash
mkdir -p screenshots/Error\ Code/新品牌名
```

**添加新型号：**
```bash
mkdir -p screenshots/Error\ Code/品牌名/新型号名
```

**添加截图文件：**
将截图文件（jpg/png）放入对应型号目录，文件名即为搜索代码，如：
- `005-120.jpg` → 搜索 `005-120` 可找到
- `010-311.jpg` → 搜索 `010` 可找到所有 010 开头的截图

### 3. 示例

添加 FUJI FILM 品牌下的 Apeos C7070 型号：

```bash
# 服务器上执行
cd /root/screenshot-app/screenshot-backend
mkdir -p screenshots/Error\ Code/FUJI\ FILM/Apeos\ C7070

# 上传截图文件到该目录
# 无需重启服务，立即生效
```

---

## 服务器部署

### 前置要求

- Linux 服务器（Ubuntu/Debian/CentOS）
- Docker 和 Docker Compose
- 开放 80 和 443 端口

### 部署步骤

**1. 安装 Docker（如未安装）**

```bash
curl -fsSL https://get.docker.com | sh
```

**2. 克隆项目**

```bash
cd /root
git clone https://github.com/LittleCrabs/screenshot-app.git
cd screenshot-app
```

**3. 上传截图文件**

将截图文件上传到 `screenshot-backend/screenshots/` 目录，按品牌/型号组织。

**4. 启动服务**

```bash
docker-compose up -d --build
```

**5. 访问**

- 前端：`http://服务器IP/`
- 后台：`http://服务器IP/admin/`
- 默认账号：`admin` / `admin123`

### 更新部署

```bash
cd /root/screenshot-app
git pull
docker-compose up -d --build
```

### 查看日志

```bash
# 查看所有日志
docker-compose logs -f

# 只看后端日志
docker-compose logs -f backend
```

### 停止服务

```bash
docker-compose down
```

---

## 更换服务器

### 1. 备份数据（旧服务器）

```bash
cd /root/screenshot-app

# 备份截图文件
tar -czvf screenshots-backup.tar.gz screenshot-backend/screenshots/

# 备份数据库（用户数据）
docker cp screenshot-backend:/app/data/db.sqlite3 ./db-backup.sqlite3
```

### 2. 迁移到新服务器

```bash
# 新服务器上安装 Docker
curl -fsSL https://get.docker.com | sh

# 克隆项目
cd /root
git clone https://github.com/LittleCrabs/screenshot-app.git
cd screenshot-app

# 上传并解压截图备份（通过 scp 或其他方式上传）
tar -xzvf screenshots-backup.tar.gz

# 启动服务
docker-compose up -d --build

# 恢复用户数据
docker cp db-backup.sqlite3 screenshot-backend:/app/data/db.sqlite3
docker-compose restart backend
```

### 3. 验证

访问 `http://新服务器IP/` 确认服务正常。

---

## SSL 证书配置（上传子域名）

项目使用独立的上传子域名 `upload.archercopier.xyz` 绕过 Cloudflare 限速，需要配置 SSL 证书。

### 1. Cloudflare DNS 配置

在 Cloudflare 添加 A 记录：
- 名称：`upload`
- 内容：服务器 IP
- 代理状态：**仅 DNS**（灰色云朵，不开启代理）

### 2. 安装 Certbot

```bash
apt update
apt install certbot -y
```

### 3. 申请证书

```bash
# 先停止 Docker 服务释放 80 端口
docker-compose stop

# 申请证书
certbot certonly --standalone -d upload.archercopier.xyz

# 按提示输入邮箱，同意条款
```

证书会保存在：
- `/etc/letsencrypt/live/upload.archercopier.xyz/fullchain.pem`
- `/etc/letsencrypt/live/upload.archercopier.xyz/privkey.pem`

### 4. 启动服务

```bash
docker-compose up -d --build
```

### 5. 证书续期

Let's Encrypt 证书有效期 90 天，设置自动续期：

```bash
# 测试续期
certbot renew --dry-run

# 添加定时任务（每天检查）
crontab -e
# 添加以下行：
0 3 * * * certbot renew --quiet && docker-compose -f /root/screenshot-app/docker-compose.yml restart frontend
```

### 6. 验证

访问 `https://upload.archercopier.xyz` 确认证书生效（应显示 404，这是正常的）。

---

## 域名配置说明

| 域名 | 用途 | Cloudflare 代理 |
|------|------|-----------------|
| edoc.archercopier.xyz | 主站（前端+API） | ✅ 开启（橙色云朵） |
| upload.archercopier.xyz | 视频上传专用 | ❌ 关闭（灰色云朵） |

上传子域名不走 Cloudflare 代理，避免大文件上传被限速。

---

